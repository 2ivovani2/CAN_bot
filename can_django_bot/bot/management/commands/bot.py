from email.mime import image
from typing import Pattern
from django.core.management.base import BaseCommand
from django.conf import settings

from telegram import Bot, Update, InlineKeyboardButton, InlineKeyboardMarkup, ParseMode, LabeledPrice
from telegram.ext import CallbackContext, Filters, MessageHandler, Updater, CommandHandler, CallbackQueryHandler, PreCheckoutQueryHandler, ConversationHandler
from telegram.utils.request import Request

from bot.models import *
from bot.report_generation import generate_report

def log_errors(f):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞, –≤—ã–≤–æ–¥—è—â–∞—è –≤—Å–µ –≤ –∫–æ–Ω—Å–æ–ª—å
        @f:function - —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
    """
    def inner(*args, **kwargs):
        try:
            return f(*args, **kwargs)
        
        except Exception as e:
            error_message = f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ {e}"
            print(error_message)
            raise e

    return inner

def user_get_by_update(update: Update):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è django instance –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """

    if update.message:
        message = update.message
    else:
        message = update.callback_query.message


    fullname = ''
    if message.chat.first_name:
        fullname += message.chat.first_name
    if message.chat.last_name:
        fullname += ' ' + message.chat.last_name

    if fullname.strip() == '':
        fullname = message.chat.username

    instance, created = TGUser.objects.update_or_create(
        external_id = message.chat.id,
        username = message.chat.username,
        name = fullname
    )

    return instance

@log_errors
def start_command_handler(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /start
    """

    user = user_get_by_update(update)
    start_reply_markup = InlineKeyboardMarkup([
        [
            InlineKeyboardButton('–û —Å–µ—Ä–≤–∏—Å–µ ‚ö°Ô∏è', callback_data='keyboard_help')
        ],
        [
            InlineKeyboardButton('–û—Ç—á–µ—Ç WB üìä', callback_data='wb_report'),
            InlineKeyboardButton('–û—Ç—á–µ—Ç OZON üìä', callback_data='ozon_report')
        ],
        [
            InlineKeyboardButton('–ë–∞–ª–∞–Ω—Å üíé', callback_data='balance_info'),
            InlineKeyboardButton('–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç üí∞', callback_data='balance_add')
        ],
        [
            InlineKeyboardButton('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ –æ—Ç—á–µ—Ç üóÇ', callback_data='demo_report')
        ],
        
    ])

    context.bot.send_message(
        chat_id=user.external_id,
        text=f'‚úãüèº –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é, <b>{user.name}</b>!\n\n–ó–∞–¥–∞—á–∞ –±–æ—Ç–∞ ‚Äì –ø–æ–º–æ—á—å –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–≤–æ–∏—Ö —Ç–æ–≤–∞—Ä–∞—Ö –∏ –æ—Ç–∑—ã–≤–∞—Ö –Ω–∞ –Ω–∏—Ö. –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –Ω–∏–∂–µ:',
        reply_markup=start_reply_markup,
        parse_mode = ParseMode.HTML
    )


@log_errors
def help_command_handler(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /help
    """
    
    user = user_get_by_update(update)

    context.bot.send_message(
        chat_id=user.external_id,
        text=f'üìä <b>–û—Å–Ω–æ–≤–Ω–æ–µ</b>:\n–≠—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö. –í—ã –±—É–¥–µ—Ç–µ –∑–Ω–∞—Ç—å –æ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞—Ö –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞—Ö –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–ª–∏ —Ç–æ–≤–∞—Ä–∞—Ö –≤–∞—à–∏—Ö –∫–æ–Ω–∫—É—Ä–µ—Ç–æ–≤. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ–º–æ-–æ—Ç—á–µ—Ç –∏ —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ üòÆ‚Äçüí®\n\nüíª <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</b>:\n{settings.COMMANDS_STRING}\n\nüí∏ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥:</b>\n–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ —Ä–∞–≤–Ω–∞ <i><b>1000‚ÇΩ</b></i>, –Ω–æ —á–µ–º –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã –±—É–¥–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —Ç–µ–º –º–µ–Ω—å—à–µ –±—É–¥–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å.\n\nüëÅ <b>–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã</b>:\n–í—ã –ø–æ–ø–æ–ª–Ω—è–µ—Ç–µ –±–∞–ª–∞–Ω—Å -> –í—ã–±–∏—Ä–∞–µ—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —É—Å–ª—É–≥—É -> –ë–æ—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç -> –ö–æ–Ω–µ—á–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF\n\nüìØ <b>–î—Ä—É–≥–æ–µ</b>:\n–ï—Å–ª–∏ –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ç–µ–º–∞—Ç–∏–∫–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤, —Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ @i_vovani –∏–ª–∏ @fathutnik –∏ –º—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–¥ –≤–∞—Å.',
        reply_markup=InlineKeyboardMarkup([
            [
                InlineKeyboardButton('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ –æ—Ç—á–µ—Ç üóÇ', callback_data='demo_report')
            ],
            [
                InlineKeyboardButton('–û—Ç—á–µ—Ç WB üìä', callback_data='wb_report'),
                InlineKeyboardButton('–û—Ç—á–µ—Ç OZON üìä', callback_data='ozon_report')
            ],

        ]),
        parse_mode = ParseMode.HTML
    )

@log_errors
def pre_checkout_handler(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ—Ç–¥–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã
    """

    chat_id = update.to_dict()['pre_checkout_query']['from']['id']
    user = TGUser.objects.get(external_id=chat_id)

    query_id = update.to_dict()['pre_checkout_query']['id']

    total_amount = int(str(update.to_dict()['pre_checkout_query']['total_amount'])[:-2])

    success = context.bot.answer_pre_checkout_query(
        pre_checkout_query_id=query_id, 
        ok=True,
    )

    if success:
        user.is_in_payment = False
        user.balance += total_amount
        user.save()

        transaction = Transaction(
            payment_id=query_id,
            amount=int(total_amount),
            user=user 
        )

        transaction.save()

        context.bot.send_message(
            chat_id=user.external_id,
            text='ü§ë –í–∞—à —Å—á–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω. –ú–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É—Å–ª—É–≥–∞–º–∏ –±–æ—Ç–∞.'
        )
    
    else:
        context.bot.send_message(
            chat_id=user.external_id,
            text='üò± –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫–∞–∫–∞—è-—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ. \n\n* –ï—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º —É –≤–∞—Å —Å–ø–∏—Å–∞–ª–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è, —Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ @i_vovani –∏–ª–∏ @fathutnik –∏ –º—ã –≤–∞–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–∂–µ–º.üòâ'
        )
    
@log_errors
def text_handler(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """

    user = user_get_by_update(update)

    if user.is_in_payment:
        user_message = update.message.text
        try:
            amt = int(user_message)
            if amt >= 1000:
                context.bot.send_message(
                    chat_id=user.external_id,
                    text=f'–û—Ç–ª–∏—á–Ω–æ, –≤—ã—Å—ã–ª–∞—é —Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Å—É–º–º—É <i><b>{amt}‚ÇΩ</b></i>.',
                    parse_mode=ParseMode.HTML
                ) 
                
                context.bot.send_invoice(
                    chat_id=user.external_id,
                    title='CAN Sentiment Analysis',
                    description=f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.username} –Ω–∞ —Å—É–º–º—É {amt}‚ÇΩ',
                    payload=f'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.username} –Ω–∞ —Å—É–º–º—É {amt}‚ÇΩ',
                    provider_token='381764678:TEST:32365',
                    currency='RUB',
                    prices=[
                        LabeledPrice(
                            label='–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
                            amount=int(f'{amt}00')
                        )
                    ]
                )

            else:
                user.is_in_payment = False
                user.save()
                context.bot.send_message(
                    chat_id=user.external_id,
                    text='üòµ‚Äçüí´ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å, –ø–æ—Å–∫–æ–ª—å–∫—É –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ - <i><b>1000‚ÇΩ</b></i>.',
                    parse_mode=ParseMode.HTML
                ) 
        except:
            user.is_in_payment = False
            user.save()
            context.bot.send_message(
                chat_id=user.external_id,
                text='üòµ‚Äçüí´ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å, —Ç–∞–∫ –∫–∞–∫ –≤—ã –≤–≤–µ–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ª–∏–±–æ —Å—É–º–º–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.\n\n<b>–ü—Ä–∏–º–µ—Ä:</b>\n1000 –∏–ª–∏ 3657 –∏–ª–∏ 1001. –û–±—ã—á–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.',
                parse_mode=ParseMode.HTML
            )

    else:
        context.bot.send_message(
                chat_id=user.external_id,
                text='üòµ –ú–æ–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –Ω–∞—É—á–∏–ª–∏ –º–µ–Ω—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ç–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è. ',
                parse_mode=ParseMode.HTML
            )

@log_errors
def balance_add_command_handler(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user = user_get_by_update(update)
    user.is_in_payment = True
    user.save()
    
    context.bot.send_message(
        chat_id=user.external_id,
        text='ü§ë –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–µ–Ω–∏—è:\n\n*–º–∏–Ω–∏–∞–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è - <i><b>1000‚ÇΩ</b></i>',
        parse_mode=ParseMode.HTML
    )
    
@log_errors
def balance_info(update:Update, context:CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è, —Å–æ–æ–±—â–∞—é—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ–≥–æ –±–∞–ª–∞–Ω—Å
    """
    user = user_get_by_update(update)

    context.bot.send_message(
        chat_id=user.external_id,
        text=f'–£–≤–∞–∂–∞–µ–º—ã–π {user.name}, –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –±–∞–ª–∞–Ω—Å –≤–∞—à–µ–≥–æ —Å—á–µ—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <i><b>{user.balance}‚ÇΩ</b></i>',
        parse_mode=ParseMode.HTML,
        reply_markup=InlineKeyboardMarkup([
            [
                InlineKeyboardButton('–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üëàüèº', callback_data='keyboard_main'),
                InlineKeyboardButton('–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç üí∞', callback_data='balance_add')
            ],

        ]),
    )

@log_errors
def demo_report_handler(update: Update, context: CallbackContext):
    """
       –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ–º–æ –æ—Ç—á–µ—Ç
    """
    user = user_get_by_update(update)

    context.bot.send_message(
        chat_id=user.external_id,
        text='üëÅ –°–µ–∫—É–Ω–¥–æ—á–∫—É... –ú—ã –≥–æ—Ç–æ–≤–∏–º –¥–µ–º–æ –æ—Ç—á–µ—Ç...'
    )

    demo_data = {
        "–¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞": {
            "–ü—Ä–∏—è—Ç–Ω—ã–π –∑–∞–ø–∞—Ö": {
                "examples": [
                    "–≠–∫–æ–Ω–æ–º–Ω–æ, —Ö–æ—Ä–æ—à–∏–π —à–∞–º–ø—É–Ω—å, –ø—Ä–∏—è—Ç–Ω—ã–π –∑–∞–ø–∞—Ö!",
                    "–•–æ—Ä–æ—à–∏–π —à–∞–º–ø—É–Ω—å, –ø—Ä–∏—è—Ç–Ω—ã–π –∑–∞–ø–∞—Ö, –≤–æ–ª–æ—Å—ã –ª—ë–≥–∫–∏–µ –∏ —à–µ–ª–∫–æ–≤–∏—Å—Ç—ã–µ."
                ],
                "rates": [
                    5,
                    5
                ],
                "mean_rate": 5.0
            },
            "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è": {
                "examples": [
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è,–≤—Å—ë —É–ø–∞–∫–æ–≤–∞–Ω–æ —Ö–æ—Ä–æ—à–æ,–ø–æ–ª—å–∑—É—é—Å—å —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–ºüëç–ª–µ–≥–∫–∏–π –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–π –∞—Ä–æ–º–∞—Ç,–±–µ—Å—Ü–≤–µ—Ç–Ω—ã–π.",
                    "–û—Ç–ª–∏—á–Ω–æ —É–ø–∞–∫–æ–≤–∞–Ω,–¥–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è,–¥–ª—è –º–æ–∏—Ö –∫–µ—Ä–∞—Ç–∏–Ω–æ–≤—ã—Ö-–æ—Ç–ª–∏—á–Ω–æ!",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è.",
                    "–®–∞–º–ø—É–Ω—å –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π, –¥–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è.",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è.",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, –±–µ—Ä—É –ø–µ—Ä–≤—ã–π —Ä–∞–∑, –µ—â—ë –Ω–µ –ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å, –Ω–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç—Ä–æ–∏–ª–∞ –∫—Ä—ã—à–∫–∞ –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –≤—Å—Ç–∞—ë—Ç –Ω–∞ –º–µ—Å—Ç–æ –∏ –∏–º–µ–µ—Ç—Å—è —â–µ–ª—å, –ø—Ä–∏ –Ω–∞–∫–ª–æ–Ω–µ –º–æ–∂–µ—Ç –≤—ã—Ç–µ—á—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, —Ñ–ª–∞–∫–æ–Ω –±–µ–∑ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ù–û.....–æ–∫–æ–ª–æ 100–º–ª –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç )",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, –ø—Ä–∏—à–ª–æ –≤—Å–µ –≤ —Ü–µ–ª–æ—Å—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ !",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–∞—è, –∫—É—Ä—å–µ—Ä–æ–º) —à–∞–º–ø—É–Ω—å –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ—Ç–µ–∫, –Ω–æ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ –æ—á–µ–Ω—å –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∑–∞–ø–∞—Ö –Ω–æ—Ä–º–∞–ª—å–Ω—ã —Å –Ω–∏–º –∑–∞–∫–∞–∑—ã–≤–∞–ª–∞ –µ—â—ë –±–∞–ª—å–∑–∞–º!"
                ],
                "rates": [
                    5,
                    5,
                    5,
                    5,
                    5,
                    4,
                    5,
                    5,
                    5,
                    5
                ],
                "mean_rate": 4.9
            },
            "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è": {
                "examples": [
                    "–ü—Ä–∏—à–µ–ª, –±—É–∫–≤–∞–ª—å–Ω–æ –∑–∞ –ø–∞—Ä—É –¥–Ω–µ–π, —É–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è, —è –¥–æ–≤–æ–ª—å–Ω–∞",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–∏–∫–∞–∫–∏—Ö –Ω–µ –±—ã–ª–æ.",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è.",
                    "–ü—Ä–æ—à—ë–ª –±—ã—Å—Ç—Ä–æ,—É–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è.",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è.",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è , –ª–∏—Ç—Ä–∞ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ –ø–æ–ª–≥–æ–¥–∞ .",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è.",
                    "–¢–æ–≤–∞—Ä —Ö–æ—Ä–æ—à–∏–π —É–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è",
                    "–£–ø–∞–∫–æ–≤–∫–∞ —Ü–µ–ª–∞—è."
                ],
                "rates": [
                    5,
                    5,
                    5,
                    4,
                    5,
                    5,
                    5,
                    5,
                    5
                ],
                "mean_rate": 4.9
            },
            "–ë—É—Ç—ã–ª–∫–∞ —Ü–µ–ª–∞—è": {
                "examples": [
                    "–•–æ—Ä–æ—à–∏–π —à–∞–º–ø—É–Ω—å , –≤—Å–µ –∑–∞–ø–µ—á–∞—Ç–∞–Ω–æ , –±—É—Ç—ã–ª–∫–∞ —Ü–µ–ª–∞—è",
                    "–ü—Ä–∏—à–ª–æ —É–ø–∞–∫–æ–≤–∞–Ω–æ –≤ –ø–∞–∫–µ—Ç–∏–∫, –±—É—Ç—ã–ª–∫–∞ —Ü–µ–ª–∞—è.",
                    "–ë—É—Ç—ã–ª–∫–∞ —Ü–µ–ª–∞—è, –Ω–µ –≤—Å–∫—Ä—ã—Ç–∞—è."
                ],
                "rates": [
                    5,
                    5,
                    5
                ],
                "mean_rate": 5.0
            },
            "–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç–ª–∏—á–Ω–∞—è": {
                "examples": [
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç–ª–∏—á–Ω–∞—è.",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç–ª–∏—á–Ω–∞—è: –ø—Ä–∏—à–ª–æ –±—ã—Å—Ç—Ä–æ –∏ —Ö–æ—Ä–æ—à–æ –∑–∞–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–º - –≤ 3 —Å–ª–æ—è –ø–ª–µ–Ω–∫–∏.",
                    "–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç–ª–∏—á–Ω–∞—è!"
                ],
                "rates": [
                    5,
                    5,
                    5
                ],
                "mean_rate": 5.0
            },
        },
        "–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏": {
            "–ö–æ—Ä–æ–±–∫–∞ –º–æ–∫—Ä–∞—è": {
                "examples": [
                    "–ø—Ä–∏—à—ë–ª —à–∞–º–ø—É–Ω—å, —É–ø–∞–∫–æ–≤–∞–Ω —Ö–æ—Ä–æ—à–æ, –Ω–æ –≤—ã—Ç–µ–∫ —à–∞–º–ø—É–Ω—å, –≤—Å—è –∫–æ—Ä–æ–±–∫–∞ –º–æ–∫—Ä–∞—è."
                ],
                "rates": [
                    3
                ],
                "mean_rate": 3.0
            },
            "–£–ø–∞–∫–æ–≤–∫–∞ –æ–±—ã—á–Ω–∞—è": {
                "examples": [
                    "–û—á–µ–Ω—å —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω–∞, –≤ –ø—É–Ω–∫—Ç–µ –≤—ã–¥–∞—á–∏ –Ω–µ –æ–±—Ä–∞—Ç–∏–ª–∞ –≤–Ω–∏–º–∞–Ω–∏–µ, –Ω–æ –∫–æ–≥–¥–∞ –ø—Ä–∏—à–ª–∞ –¥–æ–º–æ–π –∏ —Å—Ç–∞–ª–∞ —Å–Ω–∏–º–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É (–æ–±—ã—á–Ω–∞—è –ø—É–ø—ã—Ä–∫–∞) - –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞,—á—Ç–æ –∫—Ä—ã—à–∫–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ —à–∞–º–ø—É–Ω—è –≤—ã–ª–∏–ª–æ—Å—å."
                ],
                "rates": [
                    1
                ],
                "mean_rate": 1.0
            },
            "–≠—Ç–∏–∫–µ—Ç–∫–æ–π –¥–ª–∏–Ω–Ω—ã–π": {
                "examples": [
                    "–ö —à–∞–º–ø—É–Ω—é –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –ø—Ä–µ—Ç–µ–Ω–∑–∏–π, –Ω–æ –ø–æ–¥ —ç—Ç–∏–∫–µ—Ç–∫–æ–π –¥–ª–∏–Ω–Ω—ã–π –≤–æ–ª–æ—Å!"
                ],
                "rates": [
                    1
                ],
                "mean_rate": 1.0
            },
            "–ó–∞–ø–∞—Ö –¥–µ—à–µ–≤—ã–π": {
                "examples": [
                    "–ó–∞–ø–∞—Ö —É —à–∞–º–ø—É–Ω—è –¥–µ—à–µ–≤—ã–π —Ü–≤–µ—Ç–æ—á–Ω—ã–π."
                ],
                "rates": [
                    1
                ],
                "mean_rate": 1.0
            }
        }
    }

    image_link = 'https://images.wbstatic.net/c246x328/new/7540000/7546161-1.jpg'
    product_name = 'ESTEL PROFESSIONAL / –®–∞–º–ø—É–Ω—å –¥–ª—è –≤–æ–ª–æ—Å'

    pdf = generate_report(demo_data, image_link, product_name)

    context.bot.send_document(
        chat_id=user.external_id,
        document=pdf,
        caption=f'<b>{user.name}</b>, –≤–æ—Ç —Ç–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç –æ—Ç—á–µ—Ç—ã.',
        filename='demo_report.pdf',
        parse_mode=ParseMode.HTML,
        reply_markup=InlineKeyboardMarkup([
            [
                InlineKeyboardButton('–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üëàüèº', callback_data='keyboard_main'),
            ],

        ]),
    )

@log_errors
def ozon_report_handler(update: Update, context: CallbackContext):
    """
        –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ ozon
    """

    user = user_get_by_update(update)

    context.bot.send_message(
        chat_id=user.external_id,
        text='üëÄ <b>–ú—ã —Å—Ç–∞–Ω–æ–≤–∏–º—Å—è –ª—É—á—à–µ –¥–ª—è –≤–∞—Å!</b>\n–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å Ozon –ø–æ–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –Ω–æ –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, —Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ @i_vovani –∏–ª–∏ @fathutnik –∏ –º—ã —Å–¥–µ–ª–∞–µ–º –æ—Ç—á–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥ –≤–∞—Å –∑–∞ —Ç—É –∂–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å.',
        parse_mode=ParseMode.HTML,
        reply_markup=InlineKeyboardMarkup([
            [
                InlineKeyboardButton('–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üëàüèº', callback_data='keyboard_main'),
            ],
            [
                InlineKeyboardButton('–ù–∞–ø–∏—Å–∞—Ç—å üó£', url='https://t.me/i_vovani'),
            ],

        ]),
    )

class Command(BaseCommand):
    help = '–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞'

    def handle(self, *args, **kwargs):
        #1 - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        request = Request(
            connect_timeout = 1.0,
            read_timeout = 1.5
        )

        bot = Bot(
            request = request,
            token = settings.TELEGRAM_BOT_TOKEN,
        )

        #2 - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        updater = Updater(
            bot = bot,
            use_context = True,
        )

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
        start_handler = CommandHandler('start', start_command_handler)
        updater.dispatcher.add_handler(start_handler)

        menu_handler = CommandHandler('main', start_command_handler)
        updater.dispatcher.add_handler(menu_handler)

        menu_callback_handler = CallbackQueryHandler(start_command_handler, pattern='keyboard_main')
        updater.dispatcher.add_handler(menu_callback_handler)

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /help
        help_handler = CommandHandler('help', help_command_handler)
        updater.dispatcher.add_handler(help_handler)

        help_callback_handler = CallbackQueryHandler(help_command_handler, pattern='keyboard_help')
        updater.dispatcher.add_handler(help_callback_handler)

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ozon
        updater.dispatcher.add_handler(CommandHandler('ozon', ozon_report_handler))    
        updater.dispatcher.add_handler(CallbackQueryHandler(ozon_report_handler, pattern='ozon_report'))

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫  –¥–µ–º–æ –æ—Ç—á–µ—Ç–∞
        updater.dispatcher.add_handler(CommandHandler('demo_report', demo_report_handler))
        updater.dispatcher.add_handler(CallbackQueryHandler(demo_report_handler, pattern='demo_report'))

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º
        
        updater.dispatcher.add_handler(PreCheckoutQueryHandler(pre_checkout_handler, pass_chat_data=True))
        updater.dispatcher.add_handler(CallbackQueryHandler(balance_info, pattern='balance_info'))
        updater.dispatcher.add_handler(CallbackQueryHandler(balance_add_command_handler, pattern='balance_add'))
        
        updater.dispatcher.add_handler(CommandHandler('balance_add', balance_add_command_handler))    
        

        ## –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞, –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        updater.dispatcher.add_handler(MessageHandler(Filters.text, text_handler))

        #3 - –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        updater.start_polling()
        updater.idle()
